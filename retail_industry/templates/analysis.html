<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å¯è§†åŒ–åˆ†æ - é›¶å”®ä¿¡è´·ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8f9fc; }

        /* --- å¯¼èˆªæ æ ·å¼ (ç´«è‰²ä¸»é¢˜) --- */
        .navbar-custom {
            background-color: #6f42c1;
            padding-top: 0.8rem;
            padding-bottom: 0.8rem;
        }
        .navbar-brand { font-weight: bold; font-size: 1.25rem; }
        .nav-link {
            color: rgba(255,255,255,0.85) !important;
            margin-right: 20px;
            font-size: 1rem;
        }
        .nav-link:hover { color: #fff !important; }
        .nav-link.active {
            color: #fff !important;
            font-weight: bold;
            border-bottom: 2px solid #fff;
        }

        /* --- å¡ç‰‡æ ·å¼ --- */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            font-weight: bold;
            color: #333;
            padding: 1rem 1.5rem;
        }

        /* æ ‡é¢˜å·¦ä¾§ç«–çº¿è£…é¥° */
        .border-left-purple {
            border-left: 5px solid #6f42c1;
            padding-left: 15px;
            display: inline-block;
            line-height: 1.2;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom shadow-sm mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-chart-line me-2"></i>é›¶å”®ä¿¡è´·åˆ†æç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">æ•°æ®åˆ—è¡¨</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/analysis">å¯è§†åŒ–åˆ†æ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/prediction">AI é¢„æµ‹</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="text-white me-3 small">
                        <i class="fas fa-user-circle me-1"></i> (admin)
                    </span>
                    <a href="/login" class="btn btn-sm btn-light text-primary fw-bold px-3">é€€å‡º</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0 text-gray-800 border-left-purple">æ·±åº¦ç»è¥åˆ†æçœ‹æ¿</h1>
            <button class="btn btn-primary btn-sm shadow-sm" onclick="window.print()">
                <i class="fas fa-download fa-sm text-white-50 me-1"></i> å¯¼å‡ºæŠ¥å‘Š
            </button>
        </div>

        <div class="row">
            <!-- æŠ˜çº¿å›¾ - ç¼©å°æ¯”ä¾‹ -->
            <div class="col-xl-6 col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        ğŸ“ˆ ä¸šåŠ¡å¢é•¿è¶‹åŠ¿ (è¿‘6ä¸ªæœˆ)
                    </div>
                    <div class="card-body">
                        <div style="height: 300px; width: 100%;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŸ±çŠ¶å›¾ - æ”¹è¿›ä¸ºåˆ†ç»„æŸ±çŠ¶å›¾ -->
            <div class="col-xl-6 col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        ğŸ“Š è¡Œä¸šç±»å‹ç»¼åˆåˆ†æ
                    </div>
                    <div class="card-body">
                        <div style="height: 300px; width: 100%;">
                            <canvas id="barChart"></canvas>
                        </div>
                        <div class="mt-2 text-center small text-muted">
                            <span class="me-3"><i class="fas fa-chart-bar text-primary"></i> æ”¾æ¬¾é‡‘é¢</span>
                            <span class="me-3"><i class="fas fa-list text-info"></i> ç”³è¯·æ•°é‡</span>
                            <span><i class="fas fa-star text-warning"></i> å¹³å‡ä¿¡ç”¨åˆ†</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <!-- é›·è¾¾å›¾ - ä¿æŒåŸæ · -->
            <div class="col-xl-6 col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        ğŸ•¸ï¸ å®¢æˆ·ç”»åƒå¯¹æ¯”
                    </div>
                    <div class="card-body">
                        <div style="height: 320px; width: 100%; display: flex; justify-content: center;">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div class="mt-3 text-center small">
                            <span class="me-3"><i class="fas fa-circle text-success"></i> ä¼˜è´¨å®¢æˆ·</span>
                            <span><i class="fas fa-circle text-danger"></i> é£é™©å®¢æˆ·</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é¥¼å›¾ - æ”¹è¿›ä¸ºçŠ¶æ€åˆ†å¸ƒ -->
            <div class="col-xl-6 col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        ğŸ¥§ ç”³è¯·çŠ¶æ€åˆ†å¸ƒ
                    </div>
                    <div class="card-body">
                        <div style="height: 280px; width: 100%; display: flex; justify-content: center;">
                            <canvas id="pieChart"></canvas>
                        </div>
                        <div class="mt-2 small text-muted text-center" id="pieStats">
                            <!-- åŠ¨æ€æ˜¾ç¤ºç»Ÿè®¡æ•°æ® -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-primary">
                        <i class="fas fa-lightbulb me-1"></i> AI æ™ºèƒ½å†³ç­–å»ºè®®
                    </div>
                    <div class="card-body">
                        <p class="mb-2">åŸºäºç³»ç»Ÿå¯¹ MySQL æ•°æ®åº“ä¸­å†å² <strong id="insight-total" class="text-primary fs-5">...</strong> æ¡æ•°æ®çš„æ·±åº¦å­¦ä¹ åˆ†æï¼Œæˆ‘ä»¬å‘ç°ï¼š</p>

                        <ul class="mb-0 text-secondary" style="line-height: 1.8;">
                            <li>
                                <strong>é«˜é€šè¿‡ç‡ç‰¹å¾ï¼š</strong>
                                ä¿¡ç”¨è¯„åˆ†åœ¨ <code id="insight-score" class="text-success fw-bold fs-5">...</code> åˆ†ä»¥ä¸Šçš„å•†æˆ·ï¼Œè¿çº¦é£é™©æä½ï¼Œå±äºç³»ç»Ÿæ¨èçš„ä¼˜è´¨å®¢æˆ·ã€‚
                            </li>
                            <li>
                                <strong>é£é™©é¢„è­¦ï¼š</strong>
                                è¿‘æœŸâ€œ<span id="insight-industry" class="text-danger fw-bold border-bottom border-danger">...</span>â€è¡Œä¸šçš„æ‹’å•ç‡å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œå»ºè®®åœ¨ AI é¢„æµ‹æ¨¡å‹ä¸­æé«˜è¯¥è¡Œä¸šçš„å‡†å…¥é—¨æ§›ã€‚
                            </li>
                            <li>
                                <strong>è¿è¥å»ºè®®ï¼š</strong> å»ºè®®é‡ç‚¹ç»´æŠ¤é«˜ä¿¡ç”¨åˆ†ç¾¤ä½“ï¼Œå¹¶é€‚å½“æ”¶ç´§é«˜é£é™©è¡Œä¸šçš„è´·æ¬¾é¢åº¦ã€‚
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // è®¾ç½® Chart.js å…¨å±€å­—ä½“
        Chart.defaults.font.family = 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
        Chart.defaults.color = '#858796';

        document.addEventListener("DOMContentLoaded", function() {

            // 1. è¯·æ±‚åç«¯æ¥å£è·å–çœŸå®æ•°æ®
            fetch('/api/analysis-data')
                .then(response => response.json())
                .then(data => {
                    if(data.error) {
                        console.error("åŠ è½½å¤±è´¥:", data.error);
                        return;
                    }

                    // --- A. å¡«å……åº•éƒ¨çš„ AI å»ºè®®æ–‡å­— (åŠ¨æ€éƒ¨åˆ†) ---
                    if (data.insight) {
                        // å¡«æ€»æ•°
                        const totalEl = document.getElementById('insight-total');
                        if(totalEl) totalEl.innerText = data.insight.total_checked;

                        // å¡«å¹³å‡åˆ†
                        const scoreEl = document.getElementById('insight-score');
                        if(scoreEl) scoreEl.innerText = data.insight.avg_score;

                        // å¡«é£é™©è¡Œä¸š
                        const industryEl = document.getElementById('insight-industry');
                        if(industryEl) industryEl.innerText = data.insight.risky_industry;
                    }

                    // --- B. ç”»è¶‹åŠ¿å›¾ (Line Chart) ---
                    const ctxTrend = document.getElementById('trendChart').getContext('2d');
                    let gradient = ctxTrend.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(111, 66, 193, 0.2)');
                    gradient.addColorStop(1, 'rgba(111, 66, 193, 0.0)');

                    new Chart(ctxTrend, {
                        type: 'line',
                        data: {
                            labels: data.trend.labels,
                            datasets: [{
                                label: 'è´·æ¬¾ç”³è¯·é‡',
                                data: data.trend.data,
                                borderColor: '#6f42c1', // ç´«è‰²çº¿æ¡
                                backgroundColor: gradient,
                                borderWidth: 3,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#6f42c1',
                                pointRadius: 5,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                                x: { grid: { display: false } }
                            }
                        }
                    });

                    // --- C. ç”»é›·è¾¾å›¾ (Radar Chart) ---
                    const ctxRadar = document.getElementById('radarChart').getContext('2d');
                    new Chart(ctxRadar, {
                        type: 'radar',
                        data: {
                            labels: ['ä¿¡ç”¨è¯„åˆ†', 'æœˆå‡è¥æ”¶', 'ä¼ä¸šèµ„äº§'],
                            datasets: [{
                                label: 'ä¼˜è´¨å®¢æˆ·',
                                data: data.radar.good,
                                borderColor: '#1cc88a', // ç»¿è‰²
                                backgroundColor: 'rgba(28, 200, 138, 0.2)',
                                borderWidth: 2
                            }, {
                                label: 'é£é™©å®¢æˆ·',
                                data: data.radar.bad,
                                borderColor: '#e74a3b', // çº¢è‰²
                                backgroundColor: 'rgba(231, 74, 59, 0.2)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: '#eee' },
                                    grid: { color: '#eee' },
                                    pointLabels: { font: { size: 12, weight: 'bold' } }
                                }
                            }
                        }
                    });

                    // --- D. ç”»åˆ†ç»„æŸ±çŠ¶å›¾ (Grouped Bar Chart) ---
                    const ctxBar = document.getElementById('barChart').getContext('2d');
                    new Chart(ctxBar, {
                        type: 'bar',
                        data: {
                            labels: data.bar.labels,
                            datasets: [
                                {
                                    label: 'æ”¾æ¬¾é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                                    data: data.bar.amounts.map(v => v / 10000), // è½¬æ¢ä¸ºä¸‡å…ƒ
                                    backgroundColor: 'rgba(111, 66, 193, 0.8)',  // ç´«è‰²
                                    borderColor: 'rgba(111, 66, 193, 1)',
                                    borderWidth: 2,
                                    borderRadius: 5,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'ç”³è¯·æ•°é‡ï¼ˆç¬”ï¼‰',
                                    data: data.bar.counts,
                                    backgroundColor: 'rgba(52, 152, 219, 0.8)',  // è“è‰²
                                    borderColor: 'rgba(52, 152, 219, 1)',
                                    borderWidth: 2,
                                    borderRadius: 5,
                                    yAxisID: 'y1'
                                },
                                {
                                    label: 'å¹³å‡ä¿¡ç”¨åˆ†',
                                    data: data.bar.scores,
                                    backgroundColor: 'rgba(243, 156, 18, 0.8)',  // æ©™è‰²
                                    borderColor: 'rgba(243, 156, 18, 1)',
                                    borderWidth: 2,
                                    borderRadius: 5,
                                    yAxisID: 'y2',
                                    type: 'line',  // ä¿¡ç”¨åˆ†ç”¨æŠ˜çº¿æ˜¾ç¤º
                                    tension: 0.4,
                                    fill: false,
                                    pointRadius: 4,
                                    pointBackgroundColor: 'rgba(243, 156, 18, 1)'
                                }
                            ]
                        },
                        options: {
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 10,
                                        font: { size: 11 }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            let value = context.parsed.y;
                                            
                                            if (label.includes('é‡‘é¢')) {
                                                return label.split('ï¼ˆ')[0] + ': ' + value.toFixed(2) + ' ä¸‡å…ƒ';
                                            } else if (label.includes('æ•°é‡')) {
                                                return label.split('ï¼ˆ')[0] + ': ' + value + ' ç¬”';
                                            } else if (label.includes('ä¿¡ç”¨åˆ†')) {
                                                return label + ': ' + value + ' åˆ†';
                                            }
                                            return label + ': ' + value;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 10 },
                                        maxRotation: 45,
                                        minRotation: 0
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    beginAtZero: true,
                                    grid: { borderDash: [2, 2] },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(1) + 'ä¸‡';
                                        },
                                        font: { size: 9 }
                                    },
                                    title: {
                                        display: true,
                                        text: 'é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                                        font: { size: 10 }
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    grid: { display: false },
                                    ticks: {
                                        callback: function(value) {
                                            return value + 'ç¬”';
                                        },
                                        font: { size: 9 }
                                    },
                                    title: {
                                        display: true,
                                        text: 'æ•°é‡ï¼ˆç¬”ï¼‰',
                                        font: { size: 10 }
                                    }
                                },
                                y2: {
                                    type: 'linear',
                                    display: false,
                                    position: 'right',
                                    beginAtZero: false,
                                    grid: { display: false }
                                }
                            }
                        }
                    });

                    // --- E. ç”»é¥¼å›¾ (Pie Chart) - æ”¹è¿›ç‰ˆ ---
                    const ctxPie = document.getElementById('pieChart').getContext('2d');
                    
                    // å‡†å¤‡é¥¼å›¾é¢œè‰²ï¼ˆæ ¹æ®çŠ¶æ€åŠ¨æ€åˆ†é…ï¼‰
                    const pieColors = {
                        'é€šè¿‡': 'rgba(46, 204, 113, 0.8)',    // ç»¿è‰²
                        'å¾…å®¡æ ¸': 'rgba(243, 156, 18, 0.8)',  // æ©™è‰²
                        'æ‹’ç»': 'rgba(231, 74, 59, 0.8)',     // çº¢è‰²
                        'æœªé€šè¿‡': 'rgba(192, 57, 43, 0.8)'    // æ·±çº¢è‰²
                    };
                    
                    const defaultColors = [
                        'rgba(111, 66, 193, 0.8)',  // ç´«è‰²
                        'rgba(52, 152, 219, 0.8)',  // è“è‰²
                        'rgba(231, 74, 59, 0.8)',   // çº¢è‰²
                        'rgba(243, 156, 18, 0.8)',  // æ©™è‰²
                        'rgba(46, 204, 113, 0.8)'   // ç»¿è‰²
                    ];
                    
                    const pieBgColors = data.pie.labels.map((label, idx) => {
                        return pieColors[label] || defaultColors[idx % defaultColors.length];
                    });
                    
                    const pieChartInstance = new Chart(ctxPie, {
                        type: 'pie',
                        data: {
                            labels: data.pie.labels,
                            datasets: [{
                                data: data.pie.counts,
                                backgroundColor: pieBgColors,
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 12,
                                        font: { size: 11 },
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            let count = context.parsed || 0;
                                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            let percentage = ((count / total) * 100).toFixed(1);
                                            
                                            // è·å–å¯¹åº”çš„é‡‘é¢
                                            let idx = context.dataIndex;
                                            let amount = data.pie.amounts[idx] || 0;
                                            let amountStr = amount >= 10000 
                                                ? (amount / 10000).toFixed(2) + ' ä¸‡å…ƒ' 
                                                : amount.toLocaleString() + ' å…ƒ';
                                            
                                            return [
                                                label + ': ' + count + ' ç¬” (' + percentage + '%)',
                                                'é‡‘é¢: ' + amountStr
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // åœ¨é¥¼å›¾ä¸‹æ–¹æ˜¾ç¤ºç»Ÿè®¡æ‘˜è¦
                    let totalCount = data.pie.counts.reduce((a, b) => a + b, 0);
                    let totalAmount = data.pie.amounts.reduce((a, b) => a + b, 0);
                    let statsHtml = `<div class="row text-center">
                        <div class="col-6">
                            <div class="small text-muted">æ€»ç”³è¯·æ•°</div>
                            <div class="fw-bold text-primary">${totalCount.toLocaleString()} ç¬”</div>
                        </div>
                        <div class="col-6">
                            <div class="small text-muted">æ€»é‡‘é¢</div>
                            <div class="fw-bold text-primary">${totalAmount >= 10000 ? (totalAmount / 10000).toFixed(2) + ' ä¸‡å…ƒ' : totalAmount.toLocaleString() + ' å…ƒ'}</div>
                        </div>
                    </div>`;
                    
                    const pieStatsEl = document.getElementById('pieStats');
                    if (pieStatsEl) {
                        pieStatsEl.innerHTML = statsHtml;
                    }

                })
                .catch(err => console.error("å‘ç”Ÿé”™è¯¯:", err));
        });
    </script>
</body>
</html>